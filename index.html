<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map with File Uploads and Styling</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@ngageoint/geopackage/dist/geopackage.min.js"></script>
    <script src="https://unpkg.com/leaflet-kml/dist/leaflet-kml.js"></script>
    <style>
        #map { height: 600px; }
        .upload-container {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="upload-container">
        <h3>Upload Layers</h3>
        <label for="designFile">Upload Design Layer (GeoJSON, KML, GPKG):</label>
        <input type="file" id="designFile" accept=".geojson,.kml,.gpkg" />
        <br />
        <label for="actualFile">Upload Actual Layer (GeoJSON, KML, GPKG):</label>
        <input type="file" id="actualFile" accept=".geojson,.kml,.gpkg" />
        <br />
        <button id="uploadDesign">Add Design Layer</button>
        <button id="uploadActual">Add Actual Layer</button>
    </div>

    <script>
        // Ensure GeoPackageAPI is available globally
        let GeoPackageAPI = window.GeoPackage;

        // Initialize the map
        var map = L.map('map').setView([0, 0], 2);

        // Add a tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        // Function to define styles for GPKG layers
        function getStyle(feature) {
            return {
                color: feature.properties?.color || '#3388ff', // Default color if not specified
                weight: 2,
                opacity: 1,
                fillOpacity: 0.5
            };
        }

        // Function to handle file uploads
        function handleFileUpload(file, layerType) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const arrayBuffer = event.target.result;

                if (file.name.endsWith(".geojson")) {
                    let layer = L.geoJSON(JSON.parse(arrayBuffer), { style: getStyle }).addTo(map);
                    map.fitBounds(layer.getBounds());
                } else if (file.name.endsWith(".kml")) {
                    let layer = new L.KML(arrayBuffer);
                    map.addLayer(layer);
                    map.fitBounds(layer.getBounds());
                } else if (file.name.endsWith(".gpkg")) {
                    if (!GeoPackageAPI || !GeoPackageAPI.open) {
                        console.error("GeoPackageAPI is not loaded properly.");
                        alert("Error: GeoPackage support is not available.");
                        return;
                    }

                    GeoPackageAPI.open(arrayBuffer).then(geoPackage => {
                        return geoPackage.getFeatureTables();
                    }).then(layerNames => {
                        layerNames.forEach(layerName => {
                            GeoPackageAPI.queryForGeoJSONFeatures(geoPackage, layerName)
                            .then(geoJson => {
                                let gpkgLayer = L.geoJSON(geoJson, {
                                    style: getStyle,
                                    onEachFeature: function (feature, layer) {
                                        if (feature.properties) {
                                            let popupContent = "";
                                            for (let key in feature.properties) {
                                                popupContent += `<b>${key}</b>: ${feature.properties[key]}<br>`;
                                            }
                                            layer.bindPopup(popupContent);
                                        }
                                    }
                                }).addTo(map);
                                map.fitBounds(gpkgLayer.getBounds());
                            });
                        });
                    }).catch(error => {
                        console.error("Error loading GPKG:", error);
                    });
                } else {
                    alert('Unsupported file type. Please upload a GeoJSON, KML, or GPKG file.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Event listeners for the upload buttons
        document.getElementById('uploadDesign').onclick = function() {
            const fileInput = document.getElementById('designFile');
            if (fileInput.files.length > 0) {
                handleFileUpload(fileInput.files[0], 'design');
            } else {
                alert('Please select a design file to upload.');
            }
        };

        document.getElementById('uploadActual').onclick = function() {
            const fileInput = document.getElementById('actualFile');
            if (fileInput.files.length > 0) {
                handleFileUpload(fileInput.files[0], 'actual');
            } else {
                alert('Please select an actual file to upload.');
            }
        };
    </script>
</body>
</html>